{% extends 'base.html' %}
{% load static %}

{% block title %}首页 - 电影推荐系统{% endblock %}

{% block body_class %}full-bleed-header{% endblock %}

{% block content %}
<!-- Hero Section (无变化) -->
<section class="home-hero" style="background-image: url('{% static 'images/snow.jpg' %}');">
    <div class="hero-content">
        <h1>Track films you've watched.<br>
            Save those you want to see.<br>
            Tell your friends what's good.</h1>
        <p>基于你的喜好，为你推荐个性化电影</p>
        <a href="{% url 'movie_frontend:choose_favorites' %}" class="btn primary-btn">为你推荐</a>
    </div>
</section>

<!-- 热门电影部分 (MODIFIED) -->
<div class="container" style="margin-top: 3rem;">
    <section class="popular-movies">
        <!-- NEW: 带刷新按钮的标题栏 -->
        <div class="section-header">
            <h2>热门电影</h2>
            <button id="refresh-movies-btn" class="btn-refresh">
                <svg xmlns="http://www.w.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                刷新
            </button>
        </div>

        <!-- MODIFIED: 使用 include 加载电影网格 -->
        <div class="movie-grid" id="popular-movies-grid">
            {% include 'partials/_movie_grid.html' with movies=movies %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshButton = document.getElementById('refresh-movies-btn');
    const movieGrid = document.getElementById('popular-movies-grid');

    if (refreshButton && movieGrid) {
        refreshButton.addEventListener('click', function() {
            // 1. 添加加载状态，提供视觉反馈
            movieGrid.classList.add('loading');

            // 2. 发送AJAX请求到新的URL
            fetch("{% url 'movie_frontend:refresh_popular_movies' %}")
                .then(response => response.text()) // 获取HTML响应
                .then(html => {
                    // 3. 用新的HTML替换网格内容
                    movieGrid.innerHTML = html;
                })
                .catch(error => {
                    console.error('刷新电影列表时出错:', error);
                    // 可以添加错误提示
                    movieGrid.innerHTML = '<p>加载失败，请稍后再试。</p>';
                })
                .finally(() => {
                    // 4. 移除加载状态
                    movieGrid.classList.remove('loading');
                });
        });
    }
});
</script>
{% endblock %}