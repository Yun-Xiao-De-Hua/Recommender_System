{% extends 'base.html' %}
{% block title %}{{ movie.display_title }} - 电影推荐系统{% endblock %}

{% block body_class %}full-bleed-header{% endblock %}

{% block content %}

<!-- 顶部背景图区域 -->
<div class="movie-detail-header" {% if movie.backdrop_url %}style="background-image: url('{{ movie.backdrop_url }}');"{% endif %}>
    <div class="detail-header-content">
        <div class="detail-main-info">
            <img src="{{ movie.poster_url }}" alt="{{ movie.display_title }}" class="detail-poster">
            <div class="detail-title-group">
                <button onclick="history.back()" class="btn-back">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    返回
                </button>
                <h1>{{ movie.display_title }}</h1>
                <p class="meta">
                    {{ movie.release_year }}
                    {% if movie.directors.all %}
                        - Directed by
                        {% for director in movie.directors.all %}
                            <a>{{ director.name }}</a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                </p>
                {% if user.is_authenticated %}
                <div class="action-buttons">
                    <form action="{% url 'movie_frontend:toggle_watchlist' movie.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn primary-btn">
                            {% if is_in_watchlist %} 从收藏中移除 {% else %} 添加到收藏 {% endif %}
                        </button>
                    </form>
                    <form action="{% url 'movie_frontend:toggle_favorite' movie.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn favorite-btn {% if is_in_favorites %}favorited{% endif %}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 主体内容区域 -->
<div class="container movie-detail-body">
    <div class="genres">
        {% for genre in movie.genres.all %}
            <span class="genre-tag">{{ genre.name }}</span>
        {% endfor %}
    </div>

    {% if movie.summary %}
    <section class="summary">
        <h2>剧情简介</h2>
        <p>{{ movie.summary }}</p>
    </section>
    {% endif %}

    {% if movie.actors.all %}
    <section class="cast">
        <h2>主演</h2>
        <div class="cast-grid">
        {% for actor in movie.actors.all %}
            <div class="cast-member">{{ actor.name }}</div>
        {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="reviews-section">
        {% if user.is_authenticated %}
        <div class="comment-form-container card">
            <h2>发表你的看法</h2>
            <form id="comment-form" method="post" action="{% url 'movie_frontend:movie_detail' movie.id %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="{{ review_form.rating.id_for_label }}">{{ review_form.rating.label }}</label>
                    {{ review_form.rating }}
                </div>
                <div class="form-group">
                    <label for="{{ review_form.review.id_for_label }}">{{ review_form.review.label }}</label>
                    {{ review_form.review }}
                </div>
                <button type="submit" class="btn primary-btn">发布评论</button>
            </form>
        </div>
        {% else %}
        <p><a href="{% url 'login' %}?next={{ request.path }}">登录</a>后即可发表评论。</p>
        {% endif %}

        <h2 style="margin-top: 3rem;">用户评论</h2>
        <div class="reviews-list" id="user-reviews-list">
            {% for review in user_reviews %}
                {% include 'partials/_comment_card.html' with review=review user=request.user liked_review_ids=liked_review_ids %}
            {% empty %}
                <p id="no-reviews-placeholder">暂无用户评论，快来抢沙发吧！</p>
            {% endfor %}
        </div>

        <h2 style="margin-top: 3rem;">外部评论</h2>
        <div class="reviews-list">
            {% for review in external_reviews %}
                <div class="review-card">
                    <div class="review-header">
                        <div class="review-author-info">
                           <span class="review-source">{{ review.source.name }} {% if review.author %}(by {{ review.author }}){% endif %}</span>
                           {% if review.content_date %}<small class="review-timestamp">{{ review.content_date|date:"Y-m-d" }}</small>{% endif %}
                        </div>
                        {% if review.score is not None %}
                            <span class="review-score">{{ review.score|floatformat:1 }}/{{ review.source.score_max|floatformat:1 }}</span>
                        {% endif %}
                    </div>
                    <div class="review-content">
                        <p>{{ review.content }}</p>
                    </div>
                     {% if review.approvals_num is not None %}
                    <div class="review-footer">
                       <span>赞同数: {{ review.approvals_num }}</span>
                    </div>
                    {% endif %}
                </div>
            {% empty %}
                <p>暂无外部评论。</p>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 健壮的 CSRF Token 获取 ---
    const csrftokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrftokenInput) {
        console.error("CSRF token not found in any form!");
        return;
    }
    const csrftoken = csrftokenInput.value;

    const userReviewsList = document.getElementById('user-reviews-list');

    // --- 1. AJAX 提交新评论 ---
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(commentForm);

            fetch(commentForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'ok') {
                    const placeholder = document.getElementById('no-reviews-placeholder');
                    if (placeholder) placeholder.remove();
                    userReviewsList.insertAdjacentHTML('afterbegin', data.html);
                    commentForm.reset();
                }
            })
            .catch(error => {
                console.error('提交评论时出错:', error);
                alert('评论发布失败: ' + (error.errors ? JSON.stringify(error.errors) : '请检查网络或稍后重试。'));
            });
        });
    }

    // --- 2. 使用事件委托处理点赞和删除 ---
    if (userReviewsList) {
        // 分开处理 click 和 submit 事件，更清晰
        userReviewsList.addEventListener('click', function(event) {
            const likeButton = event.target.closest('.btn-like');
            if (likeButton) {
                // 点赞逻辑
                const likeSection = likeButton.closest('.like-section');
                const reviewId = likeSection.dataset.reviewId;
                fetch(`/review/${reviewId}/like/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        const likeCountSpan = likeSection.querySelector('.like-count');
                        if (likeCountSpan) likeCountSpan.textContent = `赞同数: ${data.likes_count}`;
                        likeButton.classList.toggle('liked', data.is_liked);
                    }
                })
                .catch(error => console.error('点赞时出错:', error));
            }
        });

        // --- 核心修复：为删除操作单独创建一个更精确的 'submit' 事件监听器 ---
        userReviewsList.addEventListener('submit', function(event) {
            const targetForm = event.target;
            if (targetForm.classList.contains('delete-review-form')) {
                event.preventDefault();
                if (!confirm('确定要删除这条评论吗？')) return;

                const reviewCard = targetForm.closest('.review-card');
                if (!reviewCard) return;

                fetch(targetForm.action, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => {
                    if (!response.ok) {
                        // 如果后端返回错误(如500)，也抛出异常
                        throw new Error(`服务器错误，状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'ok') {
                        reviewCard.remove();
                    } else {
                        // 处理后端返回的逻辑错误
                        alert('删除失败：' + (data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    // --- 这个 catch 块现在可以捕获所有网络和服务器错误 ---
                    console.error('删除评论时出错:', error);
                    alert('删除失败，请检查网络连接或查看F12控制台获取详细信息。');
                });
            }
        });
    }
});
</script>
{% endblock %}